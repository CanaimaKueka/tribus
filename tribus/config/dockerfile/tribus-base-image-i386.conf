FROM luisalejandro/debian-i386:wheezy
MAINTAINER Luis Alejandro Martínez Faneyth <luis@huntingbears.com.ve>
ENV DEBIAN_FRONTEND noninteractive
RUN echo "DROP DATABASE IF EXISTS test_tribus;\nDROP DATABASE IF EXISTS tribus;\nDROP ROLE IF EXISTS tribus;\nCREATE ROLE tribus PASSWORD md51a2031d64cd6f9dd4944bac9e73f52dd NOSUPERUSER CREATEDB CREATEROLE INHERIT LOGIN;\nCREATE DATABASE tribus OWNER tribus;\nGRANT ALL PRIVILEGES ON DATABASE tribus to tribus;" > /preseed-db.sql
RUN echo "dn: uid=maria,dc=tribus,dc=org\ngivenName: María Virginia\nsn: Mendez Barraza\ncn: María Virginia Mendez Barraza\nuid: maria\nmail: mvmendezb@gmail.com\nuidNumber: 10\ngidNumber: 2000\nuserPassword: 123456\nhomeDirectory: /home/maria/\nObjectClass: inetOrgPerson\nObjectClass: posixAccount\nObjectClass: top\nObjectClass: person\nObjectClass: shadowAccount\nObjectClass: organizationalPerson\nloginShell: /bin/false\ndescription: Tribus\n\ndn: uid=luis,dc=tribus,dc=org\ngivenName: Luis Alejandro\nsn: Martínez Faneyth\ncn: Luis Alejandro Martínez Faneyth\nuid: luis\nmail: luis@huntingbears.com.ve\nuidNumber: 11\ngidNumber: 2000\nuserPassword: 654321\nhomeDirectory: /home/luis/\nObjectClass: inetOrgPerson\nObjectClass: posixAccount\nObjectClass: top\nObjectClass: person\nObjectClass: shadowAccount\nObjectClass: organizationalPerson\nloginShell: /bin/false\ndescription: Tribus\n\n\ndn: uid=jose,dc=tribus,dc=org\ngivenName: José Francisco\nsn: Guerrero Rangel\ncn: José Francisco Guerrero Rangel\nuid: jose\nmail: jsfrncscg@gmail.com\nuidNumber: 12\ngidNumber: 2000\nuserPassword: 654321\nhomeDirectory: /home/jose/\nObjectClass: inetOrgPerson\nObjectClass: posixAccount\nObjectClass: top\nObjectClass: person\nObjectClass: shadowAccount\nObjectClass: organizationalPerson\nloginShell: /bin/false\ndescription: Tribus\n\n\ndn: uid=homero,dc=tribus,dc=org\ngivenName: Homero Salvador\nsn: Hernández Hernández\ncn: Homero Salvador Hernández Hernández\nuid: homero\nmail: hsh283@gmail.com\nuidNumber: 13\ngidNumber: 2000\nuserPassword: 654321\nhomeDirectory: /home/homero/\nObjectClass: inetOrgPerson\nObjectClass: posixAccount\nObjectClass: top\nObjectClass: person\nObjectClass: shadowAccount\nObjectClass: organizationalPerson\nloginShell: /bin/false\ndescription: Tribus" > /preseed-ldap.ldif
RUN echo "slapd slapd/purge_database boolean true\nslapd slapd/domain string tribus.org\nslapd shared/organization string tribus\nslapd slapd/password1 password tribus\nslapd slapd/password2 password tribus" > /preseed-debconf.conf
RUN debconf-set-selections /preseed-debconf.conf
RUN apt-get update
RUN apt-get install postgresql slapd ldap-utils redis-server mongodb-server python-xapian reprepro libxml2-dev libxslt1-dev python-dev libldap2-dev libsasl2-dev libpq-dev gcc make python-pip lsb-release git curl ca-certificates sudo uwsgi uwsgi-plugin-python nginx
RUN pip install django-tastypie==0.10.0 cssmin==0.1.4 slimit==0.8.1 docutils==0.11 sphinx==1.2b3 babel==1.3 django==1.5.2 South==0.8.2 celery==3.0.23 celery-with-redis==3.0 django-celery==3.0.23 django-redis==3.3 hiredis==0.1.1 oauth2==1.5.211 psycopg2==2.5.1 python-debian==0.1.21 python-ldap==2.4.13 python-openid==2.2.5 redis==2.8.0 chardet==2.1.1 webdriverwrapper==1.0.1 django-ldapdb==0.1.0 django-auth-ldap==1.1.4 django-social-auth==0.7.28 mimeparse==0.1.3 django-haystack==2.1.0 celery-haystack==0.7.2 mongoengine==0.8.4 mongodbforms==0.3 transifex-client==0.9.1 django-registration django-waffle==0.10 lxml flake8 coverage coveralls nodeenv sh pep257 fabric==1.8.2 pyyaml -e git+https://github.com/LuisAlejandro/django-tastypie-mongoengine.git#egg=django-tastypie-mongoengine -e git+https://github.com/joseguerrero/xapian-haystack.git#egg=xapian-haystack -e git+https://github.com/joseguerrero/django-static.git#egg=django-static
RUN echo "root:tribus" | chpasswd
RUN echo "postgres:tribus" | chpasswd
RUN service postgresql restart && sudo -iu postgres /bin/bash -c "psql -f /preseed-db.sql"
RUN service slapd restart && ldapadd -x -w "tribus" -D "cn=admin,dc=tribus,dc=org" -H "ldap://localhost" -f "/preseed-ldap.ldif"
RUN apt-get autoremove
RUN apt-get autoclean
RUN apt-get clean
RUN find /usr -name *.pyc -print0 | xargs -0r rm -rf
RUN find /var/cache/apt -type f -print0 | xargs -0r rm -rf
RUN find /var/lib/apt/lists -type f -print0 | xargs -0r rm -rf
RUN find /usr/share/man -type f -print0 | xargs -0r rm -rf
RUN find /usr/share/doc -type f -print0 | xargs -0r rm -rf
RUN find /usr/share/locale -type f -print0 | xargs -0r rm -rf
RUN find /var/log -type f -print0 | xargs -0r rm -rf
RUN find /var/tmp -type f -print0 | xargs -0r rm -rf
RUN find /tmp -type f -print0 | xargs -0r rm -rf

